# =============================================================================
# Wazuh OpenClaw Autopilot - Docker Compose Configuration
# =============================================================================
# Development and production deployment configuration
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Autopilot Runtime Service
  # ---------------------------------------------------------------------------
  autopilot:
    build:
      context: ./runtime/autopilot-service
      dockerfile: Dockerfile
    container_name: wazuh-autopilot
    restart: unless-stopped

    # Security: Read-only root filesystem
    read_only: true

    # Security: Drop all capabilities
    cap_drop:
      - ALL

    # Security: No privilege escalation
    security_opt:
      - no-new-privileges:true

    ports:
      - "127.0.0.1:${RUNTIME_PORT:-9090}:${RUNTIME_PORT:-9090}"

    # Pass all environment variables from .env file
    env_file:
      - path: .env
        required: false

    environment:
      # Overrides that must always be set for Docker (regardless of .env)
      - METRICS_HOST=0.0.0.0
      - METRICS_ENABLED=true
      - LOG_FORMAT=json
      - OPENCLAW_GATEWAY_URL=${OPENCLAW_GATEWAY_URL:-http://host.docker.internal:18789}
      - OPENCLAW_TOKEN=${OPENCLAW_TOKEN:-}

    volumes:
      # Persistent data
      - autopilot-data:/var/lib/wazuh-autopilot

      # Configuration (read-only)
      - ./policies:/etc/wazuh-autopilot/policies:ro

      # Temp filesystem for runtime
      - type: tmpfs
        target: /tmp
        tmpfs:
          size: 100M

    healthcheck:
      test: ["CMD", "node", "-e", "const h=require('http');h.get('http://localhost:'+(process.env.RUNTIME_PORT||9090)+'/health',r=>{process.exit(r.statusCode===200?0:1)}).on('error',()=>process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    networks:
      - autopilot-net

# -----------------------------------------------------------------------------
# Networks
# -----------------------------------------------------------------------------
networks:
  autopilot-net:
    driver: bridge
    internal: false

# -----------------------------------------------------------------------------
# Volumes
# -----------------------------------------------------------------------------
volumes:
  autopilot-data:
    driver: local
